@using ServISData.DataOperations
@inject IServISApi api
@inject SfDialogService dialogService

@if (Title != null)
{
	<h3>@Title</h3>
}

<div class="d-flex flex-wrap">
	<Virtualize @ref="excavatorPhotosContainer" ItemsProvider="LoadExcavatorsAsync" Context="excavator">
		<ExcavatorCard Excavator="excavator"
					   OnDelete="async () => await DeleteExcavatorAsync(excavator)" />
	</Virtualize>
</div>

@code {
	private Virtualize<Excavator> excavatorPhotosContainer = null!;

	[Parameter]
	public string Title { get; set; } = null!;

	[Parameter]
	public ExcavatorType ExcavatorType { get; set; } = null!;

	public int ExcavatorsTotalCount { get; set; } // excavators of given type (ExcavatorType)

	public async Task ReloadExcavatorsPhotosAsync()
	{
		await excavatorPhotosContainer.RefreshDataAsync();
	}

	private async ValueTask<ItemsProviderResult<Excavator>> LoadExcavatorsAsync(ItemsProviderRequest request)
	{
		if (ExcavatorsTotalCount == 0)
		{
			ExcavatorsTotalCount = await api.GetExcavatorsCountAsync(ExcavatorType);
			if (ExcavatorsTotalCount == 0)
			{// in case there is no excavator in the database
				return new ItemsProviderResult<Excavator>();
			}
		}

		int excavatorsDisplayedCount = Math.Min(request.Count, ExcavatorsTotalCount - request.StartIndex);

		var dataOperations = new MyDataOperations<Excavator>(
			new MyDataOperations<Excavator>.Configuration
				{
					Skip = request.StartIndex,
					Take = excavatorsDisplayedCount,
					SpecialOperations = (items) => items.Where(item => item.Type.Id == ExcavatorType.Id)
				});
		var excavators = await api.GetExcavatorsAsync(dataOperations);

		return new ItemsProviderResult<Excavator>(excavators, ExcavatorsTotalCount);
	}

	private async Task DeleteExcavatorAsync(Excavator excavator)
	{
		var dialogButtonOptions = new DialogButtonOptions { Content = "Zrušiť" };
		var dialogOptions = new DialogOptions
			{
				ShowCloseIcon = true,
				CancelButtonOptions = dialogButtonOptions
			};
		var isDeletionConfirmed = await dialogService.ConfirmAsync(
			content: "Naozaj chcete tento stroj vymazať natrvalo?",
			title: "Vymazať stroj natrvalo",
			options: dialogOptions
		);
		if (!isDeletionConfirmed)
		{
			return;
		}

		await api.DeleteExcavatorAsync(excavator);

		await ReloadExcavatorsPhotosAsync();
	}
}
